---
# tasks file for mclag
- name: "Breakout any port if needed"
  sonic_port_breakout:
    config:
    - name: '{{item}}'
      mode: '{{breakout_ports}}'
  loop: '{{breakout_ports}}'
  when: breakout_ports is defined

- name: Bringup server connected ports 
  sonic_interfaces:
    config:
      - name: "{{ item['name'] }}"
        enabled: true
    state: merged
  loop: "{{server_ports}}" 

- name: Bringup MCLAG peer ports 
  sonic_interfaces:
    config:
      - name: "{{ item }}"
        enabled: true
    state: merged
  loop: "{{mclag.peer_ports}}" 

- name: Associate server ports to port channel
  sonic_lag_interfaces:
    config:
      - name: "{{ item['lag'] }}"
        members:
          interfaces:
            - member: "{{ item['name'] }}"
        mode: static
  loop: "{{server_ports}}"               

- name: Associate MCLAG peer ports to port channel
  sonic_lag_interfaces:
    config:
      - name: "{{ mclag.peer_lag }}"
        members:
          interfaces:
            - member: "{{ item }}"
        mode: static
  loop: "{{mclag.peer_ports}}"   

- name: Configure MCLAG parameters
  sonic_mclag:
    config:
      domain_id: '{{mclag.domain}}'  
      peer_address: "{{loopbacks[0]['mlag_peer']}}"
      source_address: "{{loopbacks[0]['ip']}}"
      peer_link: '{{mclag.peer_lag}}'
      keepalive: 1
      session_timeout: 3
      members:
        portchannels:
          - lag: "{{item['lag']}}"
  loop: "{{server_ports}}"    

- name: Configure Vlans for the server ports
  sonic_vlans:
    config:
      - vlan_id: "{{item['svi']}}"
  loop: "{{ vlan_vni_map }}"

- name: Associate server ports to Vlans
  sonic_l2_interfaces:
    config:
      - name: "{{item.0['lag']}}"
        access:
          vlan: "{{item.1['svi']}}"
  with_together:
    - "{{server_ports}}"
    - "{{vlan_vni_map}}"

- name: Enable anycast address & configure anycast mac 
  sonic_system:
    config:
      anycast_address:
        ipv4: true
        mac_address: '{{anycast_mac_address}}'

- name: Configure anycast ip address on leaf 
  sonic_l3_interfaces:
    config:
      - name: "{{item['name']}}"
        ipv4:
          anycast_addresses: 
            - "{{item['gwip']}}"
  loop: "{{ vlan_vni_map }}"  